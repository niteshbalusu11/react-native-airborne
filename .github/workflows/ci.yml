name: "ğŸ§ª CI"

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  validate:
    name: "âœ… Validate"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ¥Ÿ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: "ğŸ“¦ Install dependencies"
        run: bun install --workspaces --frozen-lockfile

      - name: "ğŸ” Lint"
        run: |
          cd client && bun run lint
          cd ../server && bun run lint

      - name: "ğŸ§  Typecheck"
        run: |
          cd client && bun run typecheck
          cd ../server && bun run typecheck

      - name: "ğŸ§ª Test"
        run: |
          cd client && bun run test
          cd ../server && bun run test

  android-native-build:
    name: "ğŸ¤– Android Native Build"
    needs: validate
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ¥Ÿ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: "â˜• Setup Java"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: "ğŸ¤– Setup Android SDK"
        uses: android-actions/setup-android@v3

      - name: "ğŸ“¦ Install dependencies"
        run: bun install --workspaces

      - name: "âš™ï¸ Generate Android native project"
        run: |
          cd client
          bunx expo prebuild --platform android --no-install

      - name: "ğŸ—ï¸ Build Android (arm64-v8a)"
        run: |
          cd client/android
          ./gradlew :app:assembleDebug --no-daemon -PreactNativeArchitectures=arm64-v8a

  ios-native-build:
    name: "ğŸ iOS Native Build"
    needs: validate
    runs-on: macos-26
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ¥Ÿ Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: "ğŸ“¦ Install dependencies"
        run: bun install --workspaces

      - name: "âš™ï¸ Generate iOS native project"
        run: |
          cd client
          bunx expo prebuild --platform ios --no-install

      - name: "ğŸ«˜ Install CocoaPods dependencies"
        run: |
          cd client/ios
          pod install

      - name: "ğŸ—ï¸ Build iOS Simulator (arm64)"
        run: |
          set -euo pipefail
          cd client

          workspace="$(find ios -maxdepth 1 -name '*.xcworkspace' | head -n 1)"
          if [[ -z "${workspace}" ]]; then
            echo "No iOS workspace found under client/ios"
            exit 1
          fi

          scheme="$(xcodebuild -list -workspace "${workspace}" | awk '/Schemes:/{getline; gsub(/^[[:space:]]+|[[:space:]]+$/, ""); print; exit}')"
          if [[ -z "${scheme}" ]]; then
            echo "No iOS scheme found for ${workspace}"
            exit 1
          fi

          xcodebuild \
            -workspace "${workspace}" \
            -scheme "${scheme}" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            ARCHS=arm64 \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=YES \
            build -quiet
