name: ci

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install --workspaces

      - name: Lint
        run: |
          cd client && bun run lint
          cd ../server && bun run lint

      - name: Typecheck
        run: |
          cd client && bun run typecheck
          cd ../server && bun run typecheck

      - name: Test
        run: |
          cd client && bun run test
          cd ../server && bun run test

  android-native-build:
    needs: validate
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: bun install --workspaces

      - name: Generate Android native project
        run: |
          cd client
          bunx expo prebuild --platform android --no-install

      - name: Build Android (arm64-v8a)
        run: |
          cd client/android
          ./gradlew :app:assembleDebug --no-daemon -PreactNativeArchitectures=arm64-v8a

  ios-native-build:
    needs: validate
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.4"

      - name: Install dependencies
        run: bun install --workspaces

      - name: Generate iOS native project
        run: |
          cd client
          bunx expo prebuild --platform ios --no-install

      - name: Install CocoaPods dependencies
        run: |
          cd client/ios
          pod install

      - name: Build iOS Simulator (arm64)
        run: |
          set -euo pipefail
          cd client

          workspace="$(find ios -maxdepth 1 -name '*.xcworkspace' | head -n 1)"
          project="$(find ios -maxdepth 1 -name '*.xcodeproj' | head -n 1)"

          if [[ -n "${workspace}" ]]; then
            build_selector="-workspace"
            build_target="${workspace}"
          elif [[ -n "${project}" ]]; then
            build_selector="-project"
            build_target="${project}"
          else
            echo "No iOS workspace or project found under client/ios"
            exit 1
          fi

          scheme="$(xcodebuild -list "${build_selector}" "${build_target}" | awk '/Schemes:/{getline; gsub(/^[[:space:]]+|[[:space:]]+$/, ""); print; exit}')"
          if [[ -z "${scheme}" ]]; then
            echo "No iOS scheme found for ${build_target}"
            exit 1
          fi

          xcodebuild \
            "${build_selector}" "${build_target}" \
            -scheme "${scheme}" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -arch arm64 \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=YES \
            build
